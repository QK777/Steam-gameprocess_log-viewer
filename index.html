<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Steam gameprocess_log ビューア</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height:100%; }
    body{ font-family: system-ui, -apple-system, Segoe UI, sans-serif; background:#0b0f14; color:#e6edf3; margin:0;
      display:flex; flex-direction:column; overflow:hidden; }
    header{ padding:16px 20px 14px; border-bottom:1px solid #1f2a37; background:#0b0f14; position:sticky; top:0; z-index:10; }
    h1{ margin:0 0 10px; font-size:18px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .subrow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    input[type="text"]{ background:#0b1220; border:1px solid #243244; color:#e6edf3; border-radius:10px; padding:10px 12px; min-width:220px; }
    button{ position:relative; background:#162033; border:1px solid #243244; color:#e6edf3; border-radius:10px; padding:10px 12px; cursor:pointer;
      overflow:hidden; transition: transform .06s ease, border-color .12s ease; display:inline-flex; align-items:center; gap:8px; }
    button:hover{ border-color:#3b82f6; } button:active{ transform: translateY(1px); } button:disabled{ opacity:.5; cursor:not-allowed; }
    #fetchOnceBtn:disabled{
      opacity: .35;
      filter: grayscale(1);
      cursor: not-allowed;
    }

    .ripple{ position:absolute; border-radius:999px; transform: scale(0); animation: ripple .55s ease-out; background: rgba(59,130,246,.35); pointer-events:none; }
    @keyframes ripple{ to{ transform: scale(14); opacity:0; } }
    button.busy{ pointer-events:none; border-color:#3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,.12) inset; }
    .spinner{ display:none; width:14px; height:14px; border-radius:50%; border:2px solid rgba(230,237,243,.25); border-top-color: rgba(230,237,243,.85);
      animation: spin .8s linear infinite; }
    button.busy .spinner{ display:inline-block; }
    @keyframes spin{ to{ transform: rotate(360deg); } }

    .muted{ color:#9fb0c3; font-size:12px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; border:1px solid #243244; color:#cbd5e1; font-size:12px; white-space:nowrap; }
    .pathbox{ background:#0b1220; border:1px solid #243244; border-radius:10px; padding:8px 10px; }

    main{ flex:1 1 auto; overflow:hidden; }
    .tablecard{ margin: 14px 20px 16px; background:#0f172a; border:1px solid #1f2a37; border-radius:12px; width: 70%; min-width:720px; height: calc(100% - 30px); overflow:auto; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border-bottom:1px solid #1f2a37; padding:10px 8px; vertical-align:top; }
    th{ text-align:left; font-size:12px; color:#9fb0c3; position:sticky; top:0; z-index:2; background:#0f172a; user-select:none; cursor:pointer; white-space:nowrap; }
    th .sort{ margin-left:6px; opacity:.75; font-size:11px; }
    .nowrap{ white-space:nowrap; overflow-wrap:normal; word-break:normal; }
    .col-time{ min-width: 200px; } .col-dur{ min-width: 90px; } .col-app{ min-width: 90px; }

    /* テーブルを内容幅にして、列幅を固定レイアウトで厳格化 */
    .tablecard table {
      width: max-content;      /* これが効く：画面幅に引っ張られない */
      table-layout: fixed;     /* 幅指定をちゃんと守らせる */
    }

    /* 列幅を固定（必要なら数値調整） */
    .tablecard th:nth-child(1), .tablecard td:nth-child(1),
    .tablecard th:nth-child(2), .tablecard td:nth-child(2) { width: 170px; white-space: nowrap; }

    .tablecard th:nth-child(3), .tablecard td:nth-child(3) { width: 90px;  white-space: nowrap; }
    .tablecard th:nth-child(5), .tablecard td:nth-child(5) { width: 90px;  white-space: nowrap; }

    /* ゲーム列は520pxで打ち止め + 省略 */
    .tablecard th:nth-child(4), .tablecard td:nth-child(4) {
      width: 520px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #dragOverlay{ position:fixed; inset:0; background: rgba(11,15,20,.75); display:none; align-items:center; justify-content:center; z-index:9999; pointer-events:none; backdrop-filter: blur(2px); }
    #dragOverlay .box{ border:2px dashed #3b82f6; border-radius:16px; padding:18px 22px; background: rgba(15,23,42,.55); text-align:center; max-width: 680px; }
    #dragOverlay .title{ margin:0 0 6px; font-size:14px; } #dragOverlay .desc{ margin:0; color:#9fb0c3; font-size:12px; line-height:1.6; }

    .copy-tip{ position: fixed; z-index: 20000; background: #111827; border: 1px solid #243244; color: #e6edf3; font-size: 12px;
      padding: 6px 10px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,.45); opacity: 0; transform: translateY(6px);
      transition: opacity .12s ease, transform .12s ease; pointer-events: none; max-width: 70vw; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .copy-tip.show{ opacity: 1; transform: translateY(0); }
    .copy-tip::after{ content:""; position:absolute; left:14px; top:100%; border:6px solid transparent; border-top-color:#243244; }
    .copy-tip::before{ content:""; position:absolute; left:14px; top:100%; transform: translateY(-1px); border:6px solid transparent; border-top-color:#111827; }

    .callout{ margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid #243244; background:#0b1220; }
  </style>
</head>

<body>
<header>
  <h1>Steam gameprocess_log から「起動・終了」を抽出</h1>

  <div class="row">
    <button id="browseBtn" title="ファイルを参照して読み込み（最小構成の方式）">
      <span class="spinner"></span><span>ファイルを参照</span>
    </button>
    <input id="legacyFile" type="file" accept=".txt,.log" style="display:none" />

    <button id="fetchOnceBtn" title="ローカルヘルパーから1回取得（任意）" disabled>
      <span class="spinner"></span><span>ヘルパーで取得</span>
    </button>

    <button id="exportBtn" disabled title="表示中（絞り込み＋並び順）のCSVを出力">
      <span class="spinner"></span><span>CSV出力</span>
    </button>

    <input id="filter" type="text" placeholder="絞り込み（ゲーム名/AppID）" />

    <span id="status" class="muted"></span>
  </div>

  <div class="subrow">
    <span class="muted">初期設定だとここにあります</span>
    <span class="pathbox mono" id="defaultPathBox"></span>
    <span class="muted"></span>
    <button id="copyDefaultPath" title="パスをコピー（GitHub風）">
      <span class="spinner"></span><span>コピー</span>
    </button>
    <span class="muted">（ファイルダイアログのアドレスバーに貼り付け用）</span>
  </div>

  <!--
  <div class="subrow callout">
    <div class="muted" style="line-height:1.6;">
      ✅ GitHubに置く想定：このページ自体は静的なので、<b>ブラウザから .bat/.cmd を実行することはできません</b>。<br/>
      代わりに、必要ならPC側で <span class="mono">SteamLogHelper</span> を起動してから「ヘルパーから取得」を押します（ボタン押下時だけ取得なので低負荷）。
    </div>
  </div>
-->

</header>

<main>
  <div class="tablecard">
    <table>
      <thead>
        <tr>
          <th data-key="startMs" class="col-time">開始<span class="sort" id="sort-startMs"></span></th>
          <th data-key="endMs" class="col-time">終了<span class="sort" id="sort-endMs"></span></th>
          <th data-key="durMs" class="col-dur">時間<span class="sort" id="sort-durMs"></span></th>
          <th data-key="game">ゲーム（推定）<span class="sort" id="sort-game"></span></th>
          <th data-key="appid" class="col-app">AppID<span class="sort" id="sort-appid"></span></th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</main>

<div id="dragOverlay">
  <div class="box">
    <p class="title">ここに <span class="mono">gameprocess_log.txt</span> をドロップ</p>
    <p class="desc">
      どこでもドロップOK（専用枠なし）<br/>
      例：<span class="mono">C:\Program Files (x86)\Steam\logs\gameprocess_log.txt</span>
    </p>
  </div>
</div>

<script>
  const DEFAULT_LOGS_DIR_DISPLAY = 'C:\\Program Files (x86)\\Steam\\logs';
  const LS_CACHE_KEY = 'steam_log_viewer_cache_v10';
  const HELPER_LOG_URL = 'http://localhost:48765/log';

  const $defaultPathBox = document.getElementById('defaultPathBox');
  const $copyDefaultPath = document.getElementById('copyDefaultPath');
  const $browseBtn = document.getElementById('browseBtn');
  const $legacyFile = document.getElementById('legacyFile');
  const $exportBtn = document.getElementById('exportBtn');
  const $filter = document.getElementById('filter');
  const $status = document.getElementById('status');
  const $tbody = document.getElementById('tbody');
  const $dragOverlay = document.getElementById('dragOverlay');
  const $fetchOnceBtn = document.getElementById('fetchOnceBtn');

  $defaultPathBox.textContent = DEFAULT_LOGS_DIR_DISPLAY;

  let sessions = [];
  let sortKey = 'startMs';
  let sortDir = 'desc';
  let dragCounter = 0;

  function addRipple(e){
    const btn = e.currentTarget;
    if (btn.disabled) return;
    const rect = btn.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = e.clientX - rect.left - size/2;
    const y = e.clientY - rect.top - size/2;
    const span = document.createElement('span');
    span.className = 'ripple';
    span.style.width = span.style.height = size + 'px';
    span.style.left = x + 'px';
    span.style.top = y + 'px';
    btn.appendChild(span);
    span.addEventListener('animationend', () => span.remove(), { once:true });
  }
  function setBusy(btn, on){ btn.classList.toggle('busy', !!on); }

  function showTipNear(el, text = "OK") {
    const tip = document.createElement("div");
    tip.className = "copy-tip";
    tip.textContent = text;
    document.body.appendChild(tip);

    const r = el.getBoundingClientRect();
    tip.style.left = `${Math.max(8, r.left)}px`;
    tip.style.top  = `${Math.max(8, r.top - 40)}px`;

    requestAnimationFrame(() => tip.classList.add("show"));
    setTimeout(() => {
      tip.classList.remove("show");
      setTimeout(() => tip.remove(), 160);
    }, 1200);
  }

  async function copyText(text){
    try{
      if (navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(text);
        return true;
      }
    }catch(_){}
    try{
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      const ok = document.execCommand('copy');
      document.body.removeChild(ta);
      return ok;
    }catch(_){ return false; }
  }

  $copyDefaultPath.addEventListener('click', async (e) => {
    addRipple(e);
    setBusy($copyDefaultPath, true);
    const ok = await copyText(DEFAULT_LOGS_DIR_DISPLAY);
    setBusy($copyDefaultPath, false);
    showTipNear($copyDefaultPath, ok ? "コピーしました" : "コピー失敗");
  });

  function parseLine(line){
    let m = line.match(/^\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})(?:\.\d+)?\]\s+(.*)$/);
    if (m) return { ts: m[1], msg: m[2] };
    m = line.match(/^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})(?:\.\d+)?\s+(.*)$/);
    if (m) return { ts: m[1], msg: m[2] };
    return null;
  }
  function toMs(ts){
    if (!ts) return null;
    const d = new Date(ts.replace(' ', 'T'));
    const t = d.getTime();
    return Number.isFinite(t) ? t : null;
  }
  function fmtDur(ms){
    if (ms == null || !isFinite(ms) || ms < 0) return '';
    const s = Math.floor(ms/1000);
    const hh = Math.floor(s/3600);
    const mm = Math.floor((s%3600)/60);
    const ss = s%60;
    return `${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}:${ss.toString().padStart(2,'0')}`;
  }
  function basename(path){
    const p = (path||'').replace(/^"+|"+$/g,'');
    const parts = p.split(/[/\\]/);
    return parts[parts.length - 1] || p;
  }
  function guessGameNameFromCmd(cmd){
    const cleaned = (cmd||'').replace(/^"+|"+$/g,'');
    const m = cleaned.match(/steamapps[\/\\]common[\/\\]([^\/\\]+)[\/\\]/i);
    if (m) return m[1];
    const exe = basename(cleaned.split(' ')[0]);
    return exe.replace(/\.exe$/i,'') || '(unknown)';
  }
  function isHelperProcess(cmd){
    const c = (cmd||'').toLowerCase();
    return c.includes('unitycrashhandler') || c.includes('crashpad_handler') || c.includes('werfault');
  }
  function pickPrimaryCmd(processes){
    const exes = processes
      .map(p => p.cmd || '')
      .filter(cmd => /\.exe\b/i.test(cmd))
      .sort((a,b) => (isHelperProcess(a) - isHelperProcess(b)));
    const common = exes.find(cmd => /steamapps[\/\\]common/i.test(cmd) && !isHelperProcess(cmd));
    return common || exes.find(cmd => !isHelperProcess(cmd)) || exes[0] || '';
  }
  function parseSessions(text){
    const lines = text.split(/\r?\n/);
    const active = new Map();
    const out = [];

    for (const raw of lines){
      const rec = parseLine(raw);
      if (!rec) continue;

      let m = rec.msg.match(/^AppID\s+(\d+)\s+adding PID\s+(\d+)\s+as a tracked process\s+(.*)$/);
      if (m){
        const appid = m[1];
        const cmd = m[3];
        if (!active.has(appid)) active.set(appid, { appid, startTs: rec.ts, processes: [] });
        active.get(appid).processes.push({ cmd });
        continue;
      }

      m = rec.msg.match(/^Remove\s+(\d+)\s+from running list\s*$/);
      if (m){
        const appid = m[1];
        const s = active.get(appid);
        if (s){
          const primaryCmd = pickPrimaryCmd(s.processes);
          const game = guessGameNameFromCmd(primaryCmd);
          const startMs = toMs(s.startTs);
          const endMs = toMs(rec.ts);
          out.push({ appid, game, start: s.startTs, end: rec.ts, startMs, endMs, durMs: (startMs!=null&&endMs!=null)?(endMs-startMs):null });
          active.delete(appid);
        } else {
          const endMs = toMs(rec.ts);
          out.push({ appid, game:'(unknown)', start:'', end:rec.ts, startMs:null, endMs, durMs:null });
        }
      }
    }

    for (const s of active.values()){
      const primaryCmd = pickPrimaryCmd(s.processes);
      const game = guessGameNameFromCmd(primaryCmd);
      const startMs = toMs(s.startTs);
      out.push({ appid:s.appid, game, start:s.startTs, end:'', startMs, endMs:null, durMs:null });
    }
    return out;
  }

  function escapeHtml(str){
    return (str ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function updateSortIndicators(){
    for (const k of ['startMs','endMs','durMs','game','appid']){
      const el = document.getElementById('sort-' + k);
      if (!el) continue;
      el.textContent = (k === sortKey) ? ((sortDir === 'asc') ? '▲' : '▼') : '';
    }
  }
  function getViewSessions(){
    const q = ($filter.value || '').trim().toLowerCase();
    let view = sessions;
    if (q){
      view = view.filter(s => (s.game||'').toLowerCase().includes(q) || String(s.appid||'').includes(q));
    }
    const dirMul = (sortDir === 'asc') ? 1 : -1;
    return [...view].sort((a,b) => {
      const ka=a[sortKey], kb=b[sortKey];
      const aNil=(ka==null||ka===''), bNil=(kb==null||kb==='');
      if (aNil && bNil) return 0;
      if (aNil) return 1;
      if (bNil) return -1;
      if (sortKey==='game') return String(ka).localeCompare(String(kb),'ja')*dirMul;
      if (sortKey==='appid') return (Number(ka)-Number(kb))*dirMul;
      return (Number(ka)-Number(kb))*dirMul;
    });
  }
  function render(){
    const view=getViewSessions();
    $tbody.innerHTML='';
    for (const s of view){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td class="mono nowrap col-time">${escapeHtml(s.start||'')}</td>
        <td class="mono nowrap col-time">${escapeHtml(s.end||'')}</td>
        <td class="mono nowrap col-dur">${s.durMs!=null?escapeHtml(fmtDur(s.durMs)):''}</td>
        <td>${s.game?`<span class="pill">${escapeHtml(s.game)}</span>`:''}</td>
        <td class="mono nowrap col-app">${escapeHtml(String(s.appid||''))}</td>
      `;
      $tbody.appendChild(tr);
    }
    $exportBtn.disabled = (view.length===0);
    $status.textContent = `表示: ${view.length} 件 / 全 ${sessions.length} 件`;
    updateSortIndicators();
    try{
      localStorage.setItem(LS_CACHE_KEY, JSON.stringify({ savedAt:Date.now(), sessions, sortKey, sortDir, filter:$filter.value||'' }));
    }catch(_){}
  }
  $filter.addEventListener('input', render);
  document.querySelectorAll('th[data-key]').forEach(th => {
    th.addEventListener('click', () => {
      const key = th.getAttribute('data-key');
      if (!key) return;
      if (sortKey === key) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
      else { sortKey = key; sortDir = (key==='game'||key==='appid') ? 'asc' : 'desc'; }
      render();
    });
  });

  async function loadTextAndParse(text, label){
    const parsed = parseSessions(text);
    sessions = parsed;
    render();
    const lines = text.split(/\r?\n/).length;
    const msg = `${label}: ${lines}行 / セッション ${parsed.length}件`;
    $status.textContent = msg;
    showTipNear($status, msg);
  }
  async function loadFromFile(file, label){
    const text = await file.text();
    await loadTextAndParse(text, label);
  }

  // Browse
  $browseBtn.addEventListener('click', (e) => {
    addRipple(e);
    showTipNear($browseBtn, 'ファイル選択を開きました');
    $legacyFile.click();
  });
  $legacyFile.addEventListener('change', async () => {
    const f = $legacyFile.files && $legacyFile.files[0];
    if (!f) return;
    try{
      setBusy($browseBtn, true);
      await loadFromFile(f, `参照:${f.name}`);
    }catch(err){
      showTipNear($browseBtn, err?.message ?? '読み込みに失敗しました');
    }finally{
      setBusy($browseBtn, false);
      $legacyFile.value = '';
    }
  });

  // DnD
  function hasFiles(ev){
    const dt=ev.dataTransfer;
    if (!dt) return false;
    if (dt.types && Array.from(dt.types).includes('Files')) return true;
    return (dt.files && dt.files.length>0);
  }
  function showOverlay(on){ $dragOverlay.style.display = on ? 'flex' : 'none'; }
  document.addEventListener('dragenter', (e)=>{ if(!hasFiles(e)) return; dragCounter++; showOverlay(true); });
  document.addEventListener('dragleave', (e)=>{ if(!hasFiles(e)) return; dragCounter=Math.max(0,dragCounter-1); if(dragCounter===0) showOverlay(false); });
  document.addEventListener('dragover', (e)=>{ if(!hasFiles(e)) return; e.preventDefault(); });
  document.addEventListener('drop', async (e)=>{
    if(!hasFiles(e)) return;
    e.preventDefault();
    dragCounter=0; showOverlay(false);
    try{
      const dt=e.dataTransfer;
      const f = (dt.files && dt.files[0]) ? dt.files[0] : null;
      if (!f) throw new Error('ファイルが見つかりませんでした');
      await loadFromFile(f, `DnD:${f.name}`);
    }catch(err){
      showTipNear($status, err?.message ?? '読み込みに失敗しました');
    }
  });

  // Helper fetch once (button only)
  $fetchOnceBtn.addEventListener('click', async (e) => {
    addRipple(e);
    setBusy($fetchOnceBtn, true);
    try{
      const res = await fetch(HELPER_LOG_URL, { cache:'no-store' });
      if (!res.ok) throw new Error('ヘルパー未起動/取得失敗');
      const text = await res.text();
      await loadTextAndParse(text, 'ヘルパー');
      showTipNear($fetchOnceBtn, '取得しました');
    }catch(err){
      showTipNear($fetchOnceBtn, err?.message ?? '取得失敗');
    }finally{
      setBusy($fetchOnceBtn, false);
    }
  });

  // Boot restore
  (function boot(){
    try{
      const raw = localStorage.getItem(LS_CACHE_KEY);
      if (raw){
        const payload = JSON.parse(raw);
        if (payload && Array.isArray(payload.sessions)){
          sessions = payload.sessions;
          sortKey = payload.sortKey || sortKey;
          sortDir = payload.sortDir || sortDir;
          $filter.value = payload.filter || '';
          render();
          return;
        }
      }
    }catch(_){}
    $status.textContent = '未読み込み：参照 / DnD / ヘルパーから取得';
    updateSortIndicators();
  })();
</script>
</body>
</html>
